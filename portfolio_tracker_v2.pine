//@version=6
indicator("Portfolio Tracker", shorttitle="Tracker", overlay=true)

// --- âš™ï¸ SETTINGS ---
color positiveColor = input.color(color.new(color.green, 15), title="Positive Label Color")
color negativeColor = input.color(color.new(color.red, 15), title="Negative Label Color")

// --- TICKERS & AVG COSTS & QUANTITIES ---
string ticker1_id = input.string("AMZN", title="1. Ticker ID")
float  ticker1_cost = input.float(183.41, title="   Avg. Cost")
float  ticker1_qty  = input.float(359, title="   Quantity")

string ticker2_id = input.string("BN", title="2. Ticker ID (TSX)")
float  ticker2_cost = input.float(51.29, title="   Avg. Cost")
float  ticker2_qty  = input.float(1334, title="   Quantity")

string ticker3_id = input.string("GOOG", title="3. Ticker ID")
float  ticker3_cost = input.float(149.78, title="   Avg. Cost")
float  ticker3_qty  = input.float(233, title="   Quantity")

string ticker4_id = input.string("ASML", title="4. Ticker ID (US)")
float  ticker4_cost = input.float(719.78, title="   Avg. Cost")
float  ticker4_qty  = input.float(47, title="   Quantity")

string ticker5_id = input.string("BABA", title="5. Ticker ID")
float  ticker5_cost = input.float(83.71, title="   Avg. Cost")
float  ticker5_qty  = input.float(275, title="   Quantity")

string ticker6_id = input.string("MELI", title="6. Ticker ID")
float  ticker6_cost = input.float(2101.00, title="   Avg. Cost")
float  ticker6_qty  = input.float(20, title="   Quantity")

string ticker7_id = input.string("SPGI", title="7. Ticker ID")
float  ticker7_cost = input.float(495.27, title="   Avg. Cost")
float  ticker7_qty  = input.float(41, title="   Quantity")

string ticker8_id = input.string("ASML", title="8. Ticker ID (Euronext)")
float  ticker8_cost = input.float(606.21, title="   Avg. Cost")
float  ticker8_qty  = input.float(14, title="   Quantity")

string ticker9_id = input.string("EVVTY", title="9. Ticker ID")
float  ticker9_cost = input.float(73.74, title="   Avg. Cost")
float  ticker9_qty  = input.float(160, title="   Quantity")

string ticker10_id = input.string("BN", title="10. Ticker ID (US)")
float  ticker10_cost = input.float(23.11, title="   Avg. Cost")
float  ticker10_qty  = input.float(202, title="   Quantity")

string ticker11_id = input.string("SPYM", title="11. Ticker ID")
float  ticker11_cost = input.float(52.21, title="   Avg. Cost")
float  ticker11_qty  = input.float(112, title="   Quantity")

string ticker12_id = input.string("DUOL", title="12. Ticker ID")
float  ticker12_cost = input.float(242.62, title="   Avg. Cost")
float  ticker12_qty  = input.float(56, title="   Quantity")

string ticker13_id = input.string("EFX", title="13. Ticker ID")
float  ticker13_cost = input.float(236.76, title="   Avg. Cost")
float  ticker13_qty  = input.float(34, title="   Quantity")

string ticker14_id = input.string("BIDU", title="14. Ticker ID")
float  ticker14_cost = input.float(92.92, title="   Avg. Cost")
float  ticker14_qty  = input.float(43, title="   Quantity")

string ticker15_id = input.string("ADBE", title="15. Ticker ID")
float  ticker15_cost = input.float(333.03, title="   Avg. Cost")
float  ticker15_qty  = input.float(15, title="   Quantity")

string ticker16_id = input.string("BRK.B", title="16. Ticker ID")
float  ticker16_cost = input.float(332.02, title="   Avg. Cost")
float  ticker16_qty  = input.float(9, title="   Quantity")

string ticker17_id = input.string("MSCI", title="17. Ticker ID")
float  ticker17_cost = input.float(532.42, title="   Avg. Cost")
float  ticker17_qty  = input.float(8, title="   Quantity")

string ticker18_id = input.string("SCHG", title="18. Ticker ID")
float  ticker18_cost = input.float(25.14, title="   Avg. Cost")
float  ticker18_qty  = input.float(127, title="   Quantity")

string ticker19_id = input.string("CSPX", title="19. Ticker ID")
float  ticker19_cost = input.float(568.19, title="   Avg. Cost")
float  ticker19_qty  = input.float(5.197501, title="   Quantity")

string ticker20_id = input.string("CRM", title="20. Ticker ID")
float  ticker20_cost = input.float(245.00, title="   Avg. Cost")
float  ticker20_qty  = input.float(11, title="   Quantity")

string ticker21_id = input.string("WPEA", title="21. Ticker ID")
float  ticker21_cost = input.float(4.85, title="   Avg. Cost")
float  ticker21_qty  = input.float(301, title="   Quantity")

string ticker22_id = input.string("IWDA", title="22. Ticker ID")
float  ticker22_cost = input.float(108.85, title="   Avg. Cost")
float  ticker22_qty  = input.float(0.918737, title="   Quantity")

string ticker23_id = input.string("NFLX", title="23. Ticker ID")
float  ticker23_cost = input.float(108.709, title="   Avg. Cost")
float  ticker23_qty  = input.float(8, title="   Quantity")

string ticker24_id = input.string("TQQQ", title="24. Ticker ID")
float  ticker24_cost = input.float(53.185, title="   Avg. Cost")
float  ticker24_qty  = input.float(599, title="   Quantity")

// --- ðŸ§  LOGIC ---
// Using simplified ticker matching to avoid Exchange issues (BATS vs NASDAQ)
string simpleTicker = syminfo.ticker
string currencyCode = syminfo.currency
float avgCost = na
float qty = na

// Helper function to match Ticker. 
// It checks if the Input matches the Simple Ticker (e.g. "AMZN" == "AMZN")
// OR if the full ticker contains the input (legacy support).
match(id) => id != "" and (simpleTicker == id or str.contains(syminfo.tickerid, id))

// Logic Block
if match(ticker1_id)
    avgCost := ticker1_cost
    qty := ticker1_qty
else if match(ticker2_id) and currencyCode == "CAD" // BN (Canada)
    avgCost := ticker2_cost
    qty := ticker2_qty
else if match(ticker3_id)
    avgCost := ticker3_cost
    qty := ticker3_qty
else if match(ticker4_id) and currencyCode == "USD" // ASML (US)
    avgCost := ticker4_cost
    qty := ticker4_qty
else if match(ticker5_id)
    avgCost := ticker5_cost
    qty := ticker5_qty
else if match(ticker6_id)
    avgCost := ticker6_cost
    qty := ticker6_qty
else if match(ticker7_id)
    avgCost := ticker7_cost
    qty := ticker7_qty
else if match(ticker8_id) and currencyCode == "EUR" // ASML (Euronext)
    avgCost := ticker8_cost
    qty := ticker8_qty
else if match(ticker9_id)
    avgCost := ticker9_cost
    qty := ticker9_qty
else if match(ticker10_id) and currencyCode == "USD" // BN (US)
    avgCost := ticker10_cost
    qty := ticker10_qty
else if match(ticker11_id)
    avgCost := ticker11_cost
    qty := ticker11_qty
else if match(ticker12_id)
    avgCost := ticker12_cost
    qty := ticker12_qty
else if match(ticker13_id)
    avgCost := ticker13_cost
    qty := ticker13_qty
else if match(ticker14_id)
    avgCost := ticker14_cost
    qty := ticker14_qty
else if match(ticker15_id)
    avgCost := ticker15_cost
    qty := ticker15_qty
else if match(ticker16_id)
    avgCost := ticker16_cost
    qty := ticker16_qty
else if match(ticker17_id)
    avgCost := ticker17_cost
    qty := ticker17_qty
else if match(ticker18_id)
    avgCost := ticker18_cost
    qty := ticker18_qty
else if match(ticker19_id)
    avgCost := ticker19_cost
    qty := ticker19_qty
else if match(ticker20_id)
    avgCost := ticker20_cost
    qty := ticker20_qty
else if match(ticker21_id)
    avgCost := ticker21_cost
    qty := ticker21_qty
else if match(ticker22_id)
    avgCost := ticker22_cost
    qty := ticker22_qty
else if match(ticker23_id)
    avgCost := ticker23_cost
    qty := ticker24_qty
else if match(ticker24_id)
    avgCost := ticker24_cost
    qty := ticker24_qty

// --- DRAWING THE LINE ---
plot(series=avgCost, title="Average Cost", color=color.green, linewidth=2, style=plot.style_line, trackprice=true)

// --- LABEL LOGIC ---
var label percentLabel = na

if barstate.islast and not na(avgCost)
    float percent_diff = (close - avgCost) / avgCost * 100
    float totalPL = (close - avgCost) * qty
    string sign = percent_diff >= 0 ? "+" : ""
    string plSign = totalPL >= 0 ? "+" : ""

    string labelText = sign + str.tostring(percent_diff, "#.##") + "%\n" + plSign + "$" + str.tostring(totalPL, "#,###.##")

    color bgColor = percent_diff >= 0 ? positiveColor : negativeColor

    if na(percentLabel)
        percentLabel := label.new(
             x=bar_index,
             y=avgCost,
             text=labelText,
             xloc=xloc.bar_index,
             yloc=yloc.price,
             style=label.style_label_left,
             color=bgColor,
             textcolor=color.white,
             size=size.normal
             )
    else
        label.set_xy(percentLabel, bar_index, avgCost)
        label.set_text(percentLabel, labelText)
        label.set_color(percentLabel, bgColor)
else
    if not na(percentLabel)
        label.delete(percentLabel)
        percentLabel := na